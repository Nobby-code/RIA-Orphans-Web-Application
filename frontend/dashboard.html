<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RIA Orphans Dashboard</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      .mainpage {
        min-height: 100vh;
        display: flex;
        /* flex-direction: column; */
      }
      #sidebar {
        min-width: 220px;
        max-width: 220px;
        background-color: #343a40;
        color: white;
        min-height: 100vh;
      }
      #sidebar a {
        color: white;
        text-decoration: none;
      }
      #sidebar .nav-link.active {
        background-color: #495057;
      }
      #content {
        flex-grow: 1;
        padding: 20px;
      }
      .card {
        margin-bottom: 20px;
      }
      .orphan-img {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border-radius: 50%;
      }
      .quick-action {
        margin-bottom: 15px;
      }

      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .modal-content {
        background: white;
        padding: 20px;
        border-radius: 10px;
        width: 400px;
        position: relative;
      }

      .close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        cursor: pointer;
      }

      .logoutMessageBox {
        max-width: 430px;
        width: 80%;
        margin-bottom: 20px;
      }

      .nav-link {
        color: #333;
        padding: 10px 15px;
      }

      .nav-link.active {
        background-color: #ff6d12;
        color: #fff;
        border-radius: 5px;
      }
    </style>
  </head>
  <body>
    <div
      id="logoutMessage"
      class="alert d-none logoutMessageBox text-center"
      role="alert"
    ></div>
    <!-- Sidebar -->
    <div class="mainpage">
      <div id="sidebar" class="d-flex flex-column p-3">
        <h3 class="text-center mb-4">Admin Dashboard</h3>
        <ul class="nav nav-pills flex-column mb-auto">
          <li class="nav-item">
            <a href="dashboard.html" class="nav-link active-link"
              ><i class="fas fa-home me-2"></i> Dashboard</a
            >
          </li>
          <li>
            <a href="#" class="nav-link" data-page="orphans"
              ><i class="fas fa-child me-2"></i> Orphans</a
            >
          </li>
          <li>
            <a href="#" class="nav-link" data-page="widows">
              <i class="fas fa-female me-2"></i> Widows
            </a>
          </li>
          <li>
            <a href="#" class="nav-link" data-page="donors">
              <i class="fas fa-briefcase me-2"></i> Donors</a
            >
          </li>
          <li>
            <a href="#" class="nav-link" data-page="donations">
              <i class="fas fa-donate me-2"></i> Donations</a
            >
          </li>
          <li>
            <a href="#" class="nav-link" data-page="programs">
              <i class="fas fa-project-diagram me-2"></i> Programs</a
            >
          </li>
          <li>
            <a href="#" class="nav-link" data-page="events">
              <i class="fas fa-calendar-alt me-2 me-2"></i> Events</a
            >
          </li>
          <li>
            <a href="#" class="nav-link" data-page="users">
              <i class="fas fa-users me-2"></i> Users</a
            >
          </li>
          <li>
            <a href="#" class="nav-link" data-page="reports">
              <i class="fas fa-chart-bar me-2"></i> Reports</a
            >
          </li>
          <li>
            <a href="#" class="nav-link" id="logoutBtn">
              <i class="fas fa-sign-out-alt me-2"></i> Logout</a
            >
          </li>
        </ul>
      </div>

      <!-- Main Content -->
      <div id="content">
        <!-- Topbar -->
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
          <div class="container-fluid">
            <span class="navbar-brand">RIA Orphans Dashboard</span>
          </div>
        </nav>

        <!-- Quick Actions -->
        <div class="d-flex quick-action">
          <a href="create-orphan.html" class="btn btn-success me-3"
            ><i class="fas fa-plus me-1"></i> Add Orphan</a
          >
          <a href="create-widow.html" class="btn btn-warning me-3"
            ><i class="fas fa-plus me-1"></i> Add Widow</a
          >
          <a href="add-donation.html" class="btn btn-primary"
            ><i class="fas fa-plus me-1"></i> Add Donation</a
          >
          <a href="create-program.html" class="btn btn-info me-3">
            <i class="fas fa-plus me-1"></i> Add Program
          </a>
        </div>

        <!-- Stats Cards -->
        <div class="row">
          <div class="col-md-4">
            <div class="card text-center">
              <div class="card-body">
                <h5 class="card-title">Total Orphans</h5>
                <p class="card-text fs-3" id="totalOrphans">0</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-center">
              <div class="card-body">
                <h5 class="card-title">Total Widows</h5>
                <p class="card-text fs-3" id="totalOrphans">0</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-center">
              <div class="card-body">
                <h5 class="card-title">Total Donations</h5>
                <p class="card-text fs-3" id="totalDonations">0</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card text-center">
              <div class="card-body">
                <h5 class="card-title">Total Users</h5>
                <p class="card-text fs-3" id="totalUsers">0</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="row">
          <div class="col-md-6">
            <div class="card">
              <div class="card-header"><h5>Orphans by Gender</h5></div>
              <div class="card-body">
                <canvas id="genderChart"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card">
              <div class="card-header"><h5>Orphans by Age Group</h5></div>
              <div class="card-body">
                <canvas id="ageChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Orphans Table -->
        <div class="card mt-4">
          <div class="card-header"><h5>Recent Orphans</h5></div>
          <div class="card-body">
            <table class="table table-striped" id="orphansTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Image</th>
                  <th>Name</th>
                  <th>Age</th>
                  <th>Gender</th>
                  <th>Description</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="6" class="text-center">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="card mt-4">
          <div class="card-header">
            <h5>Recent Widows</h5>
          </div>
          <div class="card-body">
            <table class="table table-striped" id="widowsTable">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Name</th>
                  <th>Age</th>
                  <th>No of Children</th>
                  <th>Location</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="6" class="text-center">No widows available</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Edit Orphan Modal -->
      <div id="editOrphanModal" class="modal" style="display: none">
        <div class="modal-content">
          <span class="close" onclick="closeModal()">&times;</span>
          <h2>Edit Orphan</h2>
          <form id="editOrphanForm">
            <input type="hidden" id="editOrphanId" />
            <div>
              <label>Name:</label>
              <input type="text" id="editName" required />
            </div>
            <div>
              <label>Age:</label>
              <input type="number" id="editAge" required />
            </div>
            <div>
              <label>Gender:</label>
              <select id="editGender" required>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
              </select>
            </div>
            <div>
              <label>Description:</label>
              <textarea id="editDescription"></textarea>
            </div>
            <div>
              <label>Image URL:</label>
              <input type="text" id="editImage" />
            </div>
            <button type="submit">Save Changes</button>
          </form>
        </div>
      </div>
    </div>

    <!-- JS -->
    <script src="js/config.js"></script>
    <script>
      const token = localStorage.getItem("token");
      const role = localStorage.getItem("role");

      if (!token || role !== "admin") {
        window.location.href = "login.html";
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // const API_URL = "http://localhost:5000/api";
      const API_URL = window.API_BASE_URL;

      async function loadDashboard() {
        try {
          const orphanRes = await fetch(`${API_URL}/orphans`);
          const orphanData = await orphanRes.json();

          const totalOrphans = orphanData.success ? orphanData.data.length : 0;
          document.getElementById("totalOrphans").innerText = totalOrphans;

          const orphansTable = document.querySelector("#orphansTable tbody");
          orphansTable.innerHTML = "";

          if (totalOrphans === 0) {
            orphansTable.innerHTML = `<tr><td colspan="6" class="text-center">No orphans found</td></tr>`;
          } else {
            orphanData.data
              .slice(-5)
              .reverse()
              .forEach((orphan, index) => {
                const imageSrc = orphan.image
                  ? `${API_URL}${orphan.image}`
                  : "images/default.jpg";
                orphansTable.innerHTML += `
                    <tr>
                      <td>${index + 1}</td>
                      <td><img src="${imageSrc}" class="orphan-img" alt="${
                  orphan.name
                }" /></td>
                      <td>${orphan.name}</td>
                      <td>${orphan.age || "-"}</td>
                      <td>${orphan.gender || "-"}</td>
                      <td>${orphan.description || "-"}</td>
                      <td>
                          <button class="btn btn-sm btn-warning" onclick='openModal(${JSON.stringify(
                            orphan
                          )})'>
                          <i class="fas fa-edit"></i> Edit
                          </button>
                      </td>
                    </tr>
                  `;
              });
          }
          // Recent widows
          const widowsRes = await fetch(`${API_URL}/widows`);
          const widowsData = await widowsRes.json();

          const widowsTable = document.querySelector("#widowsTable tbody");
          widowsTable.innerHTML = "";

          widowsData.data.forEach((widow, index) => {
            widowsTable.innerHTML += `
                    <tr>
                    <td>${index + 1}</td>
                    <td>${widow.name}</td>
                    <td>${widow.age || "-"}</td>
                    <td>${widow.numberOfChildren || "-"}</td>
                    <td>${widow.location || "-"}</td>
                    <td>${widow.description || "-"}</td>
                    <td>
                        <button class="btn btn-sm btn-warning">Edit</button>
                    </td>
                    </tr>
                `;
          });

          // Fetch total donations
          const donationsRes = await fetch(`${API_URL}/donations/total`);
          const donationsData = await donationsRes.json();
          document.getElementById("totalDonations").innerText =
            donationsData.success
              ? `KES ${donationsData.total.toLocaleString()}`
              : "KES 0";

          // Fetch total users
          const usersRes = await fetch(`${API_URL}/users/total`);
          const usersData = await usersRes.json();
          document.getElementById("totalUsers").innerText = usersData.success
            ? usersData.total
            : 0;

          // Prepare data for charts
          const genderCounts = { Male: 0, Female: 0, Other: 0 };
          const ageGroups = {
            "0-5": 0,
            "6-10": 0,
            "11-15": 0,
            "16-18": 0,
            "19+": 0,
          };

          orphanData.data.forEach((o) => {
            const gender = o.gender ? o.gender.trim().toLowerCase() : "Other";
            if (gender === "male") genderCounts.Male++;
            else if (gender === "female") genderCounts.Female++;
            else genderCounts.Other++;

            const age = o.age || 0;
            if (age <= 5) ageGroups["0-5"]++;
            else if (age <= 10) ageGroups["6-10"]++;
            else if (age <= 15) ageGroups["11-15"]++;
            else if (age <= 18) ageGroups["16-18"]++;
            else ageGroups["19+"]++;
          });

          // Gender Chart
          new Chart(document.getElementById("genderChart"), {
            type: "pie",
            data: {
              labels: Object.keys(genderCounts), // ["Male", "Female", "Other"]
              datasets: [
                {
                  data: Object.values(genderCounts),
                  backgroundColor: ["#36A2EB", "#FF6384", "#FFCE56"],
                },
              ],
            },
          });

          // Age Chart
          new Chart(document.getElementById("ageChart"), {
            type: "bar",
            data: {
              labels: Object.keys(ageGroups),
              datasets: [
                {
                  label: "Number of Orphans",
                  data: Object.values(ageGroups),
                  backgroundColor: "#36A2EB",
                },
              ],
            },
            options: { scales: { y: { beginAtZero: true } } },
          });
        } catch (err) {
          console.error("Error loading dashboard:", err);
        }
      }

      loadDashboard();
    </script>
    <script>
      function openModal(orphan) {
        document.getElementById("editOrphanId").value = orphan._id;
        document.getElementById("editName").value = orphan.name;
        document.getElementById("editAge").value = orphan.age;
        document.getElementById("editGender").value = orphan.gender;
        document.getElementById("editDescription").value =
          orphan.description || "";
        document.getElementById("editImage").value = orphan.image || "";

        document.getElementById("editOrphanModal").style.display = "flex";
      }

      function closeModal() {
        document.getElementById("editOrphanModal").style.display = "none";
      }
    </script>
    <script>
      function getToken() {
        return localStorage.getItem("token");
      }
      document
        .getElementById("editOrphanForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const id = document.getElementById("editOrphanId").value;
          const name = document.getElementById("editName").value;
          const age = parseInt(document.getElementById("editAge").value);
          const gender = document.getElementById("editGender").value;
          const description = document.getElementById("editDescription").value;
          const image = document.getElementById("editImage").value;

          try {
            const res = await fetch(`${API_URL}/orphans/${id}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${getToken()}`,
              },
              //   Authorization: `Bearer ${getToken()}`,
              body: JSON.stringify({ name, age, gender, description, image }),
            });

            const data = await res.json();

            if (data.success) {
              alert("Orphan updated successfully!");
              closeModal();
              loadDashboard(); // refresh table and charts
            } else {
              alert("Failed to update orphan: " + data.message);
            }
          } catch (err) {
            console.error(err);
            alert("Error updating orphan");
          }
        });
    </script>

    <script>
      // Logout functionality

      const logoutMessageBox = document.getElementById("logoutMessage");

      function showLogoutMessage(message, type = "danger") {
        logoutMessageBox.textContent = message;
        logoutMessageBox.className = `alert alert-${type}`;
        logoutMessageBox.classList.remove("d-none");
      }

      const logoutButton = document.getElementById("logoutBtn");
      logoutButton.addEventListener("click", () => {
        localStorage.removeItem("token");
        localStorage.removeItem("role");
        // alert("You have been logged out.");
        showLogoutMessage("You have been logged out.", "success");
        setTimeout(() => {
          window.location.href = "login.html";
        }, 1200);
      });
    </script>
    <script src="js/dashboard.js"></script>
  </body>
</html>
