<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create Orphan</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Favicon -->
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="images/cropped-favicon-32x32.png"
    />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css" />

    <!--CSS Plugins-->
    <link rel="stylesheet" href="css/plugin.css" />
    <!-- Default CSS-->
    <link rel="stylesheet" href="css/default.css" />
    <!--Custom CSS-->
    <link rel="stylesheet" href="css/styles.css" />

    <!-- Font Awesome 4.7.0 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <!-- Font Awesome 5 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />

    <style>
      body {
        background: #eef1f5;
        padding: 40px 0;
      }
      .form-card {
        max-width: 650px;
        margin: 10px auto;
        background: #fff;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
      }
      .btn-primary {
        border-radius: 30px;
        padding: 10px 18px;
      }
      button:disabled {
        cursor: not-allowed;
      }

      /* #imagePreview {
        border: 1px solid #dee2e6;
        padding: 5px;
        background: #fff;
      } */
    </style>
  </head>

  <body>
    <!-- Header Section Start -->
    <div id="site-header"></div>
    <!-- Header Section End -->

    <div class="form-card">
      <h3 class="fw-bold text-center mb-2">Create New Orphan</h3>
      <p class="text-muted text-center mb-4">
        Fill the details below to add orphan information
      </p>

      <form id="orphanForm">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="fw-semibold">Full Name</label>
            <input
              type="text"
              id="name"
              class="form-control"
              placeholder="Enter full name"
              required
            />
          </div>

          <div class="col-md-6 mb-3">
            <label class="fw-semibold">Gender</label>
            <select id="gender" class="form-select" required>
              <option>Male</option>
              <option>Female</option>
            </select>
          </div>

          <!-- <div class="col-md-6 mb-3">
            <label class="fw-semibold">Age</label>
            <input
              type="number"
              id="age"
              class="form-control"
              placeholder="Enter age"
              required
            />
          </div> -->
          <div class="col-md-6 mb-3">
            <label class="fw-semibold">Date of Birth</label>
            <input type="date" id="dob" class="form-control" required />
          </div>

          <div class="col-md-6 mb-3">
            <label class="fw-semibold">Age</label>
            <input type="number" id="age" class="form-control" readonly />
          </div>

          <div class="col-md-6 mb-3">
            <label class="fw-semibold">Orphan Type</label>
            <select id="orphanType" class="form-select" required>
              <option value="">Select orphan type</option>
              <option value="total">Total Orphan</option>
              <option value="partial">Partial Orphan</option>
            </select>
          </div>

          <div class="col-md-6 mb-3 d-none" id="deceasedParentGroup">
            <label class="fw-semibold">Who is Deceased?</label>
            <select id="deceasedParent" class="form-select">
              <option value="">Select parent</option>
              <option value="father">Father</option>
              <option value="mother">Mother</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="fw-semibold">Story / Background</label>
            <textarea
              id="description"
              class="form-control"
              rows="4"
              placeholder="Write a short story"
            ></textarea>
          </div>

          <div class="col-md-6 mb-3">
            <label class="fw-semibold">Upload Photo (optional)</label>
            <input
              type="file"
              id="image"
              class="form-control"
              accept="image/*"
            />
          </div>
        </div>

        <!-- Image Preview -->
        <div class="mt-3 text-center">
          <img
            id="imagePreview"
            src=""
            alt="Image Preview"
            class="img-fluid rounded shadow d-none"
            style="max-height: 200px"
          />
        </div>

        <!-- <div class="text-center">
          <button class="btn btn-primary w-100 rounded-0 mt-3">
            Save Orphan
          </button>
        </div> -->
        <button
          type="submit"
          id="submitBtn"
          class="btn btn-primary w-100 mt-3"
          autocomplete="off"
        >
          <span id="btnText">Save Orphan</span>
          <span
            id="btnSpinner"
            class="spinner-border spinner-border-sm ms-2 d-none"
            role="status"
            aria-hidden="true"
          ></span>
        </button>
      </form>
    </div>

    <!-- Success Modal -->
    <div
      class="modal fade"
      id="successModal"
      tabindex="-1"
      aria-labelledby="successModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="successModalLabel">
              <i class="fas fa-check-circle me-2"></i> Success
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>

          <div class="modal-body text-center py-4">
            <!-- <h5 class="mb-2">Orphan Created Successfully ðŸŽ‰</h5> -->
            <p class="text-muted mb-0">
              The orphan record saved successfully!.
            </p>
          </div>

          <div class="modal-footer justify-content-center">
            <button
              type="button"
              class="btn btn-success px-4"
              data-bs-dismiss="modal"
            >
              OK
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">
              <i class="fas fa-times-circle me-2"></i> Error
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body text-center">
            <p id="errorMessage" class="mb-0"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer Starts -->
    <!-- <div id="site-footer"></div> -->
    <!-- Footer Ends -->

    <script src="js/layout.js"></script>

    <script src="js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const orphanType = document.getElementById("orphanType");
      const deceasedParentGroup = document.getElementById(
        "deceasedParentGroup"
      );
      const deceasedParent = document.getElementById("deceasedParent");

      const submitBtn = document.getElementById("submitBtn");
      const btnText = document.getElementById("btnText");
      const btnSpinner = document.getElementById("btnSpinner");

      // Image elements
      const imageInput = document.getElementById("image");
      const imagePreview = document.getElementById("imagePreview");

      // DOB and Age elements
      const dobInput = document.getElementById("dob");
      const ageInput = document.getElementById("age");

      function setLoading(isLoading) {
        if (isLoading) {
          submitBtn.disabled = true;
          btnText.innerText = "Saving...";
          btnSpinner.classList.remove("d-none");
        } else {
          submitBtn.disabled = false;
          btnText.innerText = "Save Orphan";
          btnSpinner.classList.add("d-none");
        }
      }

      document
        .getElementById("orphanForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          setLoading(true);

          const formData = new FormData();
          formData.append("name", document.getElementById("name").value);
          formData.append("gender", document.getElementById("gender").value);
          formData.append("dob", document.getElementById("dob").value);
          formData.append("age", document.getElementById("age").value);
          formData.append(
            "orphanType",
            document.getElementById("orphanType").value
          );

          if (orphanType.value === "partial") {
            formData.append(
              "deceasedParent",
              document.getElementById("deceasedParent").value
            );
          }
          formData.append(
            "description",
            document.getElementById("description").value
          );

          const imageFile = document.getElementById("image").files[0];
          if (imageFile) {
            formData.append("image", imageFile);
          }

          try {
            const res = await createOrphan(formData);

            setLoading(false);

            if (res.success) {
              // alert("Orphan created successfully!");
              document.getElementById("orphanForm").reset();
              imagePreview.src = "";
              imagePreview.classList.add("d-none");
              const successModal = new bootstrap.Modal(
                document.getElementById("successModal")
              );
              successModal.show();
            } else {
              // alert(res.message || "Failed to create orphan");
              document.getElementById("errorMessage").innerText =
                res.message || "Failed to create orphan";
              const errorModal = new bootstrap.Modal(
                document.getElementById("errorModal")
              );
              errorModal.show();
            }
          } catch (err) {
            setLoading(false);
            console.error("Error creating orphan:", err);
            document.getElementById("errorMessage").innerText =
              "An error occured, Try again.";
            const errorModal = new bootstrap.Modal(
              document.getElementById("errorModal")
            );
            errorModal.show();
          } finally {
            setLoading(false);
          }
        });

      // Show/hide deceased parent based on orphan type
      orphanType.addEventListener("change", () => {
        if (orphanType.value === "partial") {
          deceasedParentGroup.classList.remove("d-none");
          deceasedParent.setAttribute("required", "required");
        } else {
          deceasedParentGroup.classList.add("d-none");
          deceasedParent.removeAttribute("required");
        }
      });

      // Image preview
      imageInput.addEventListener("change", () => {
        const file = imageInput.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            imagePreview.src = e.target.result;
            imagePreview.classList.remove("d-none");
          };
          reader.readAsDataURL(file);
        } else {
          imagePreview.src = "";
          imagePreview.classList.add("d-none");
        }
      });

      // Auto-calculate age from DOB
      dobInput.addEventListener("change", () => {
        const dob = new Date(dobInput.value);
        const today = new Date();

        if (!dobInput.value) {
          ageInput.value = "";
          return;
        }

        let age = today.getFullYear() - dob.getFullYear();
        const monthDiff = today.getMonth() - dob.getMonth();
        const dayDiff = today.getDate() - dob.getDate();

        // Adjust age if birthday hasn't occurred yet this year
        if (monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)) {
          age--;
        }

        ageInput.value = age >= 0 ? age : "";
      });
      dobInput.max = new Date().toISOString().split("T")[0];
    </script>
  </body>
</html>
